<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Type Ahead ğŸ‘€</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <form class="search-form">
        <input type="text" class="search" placeholder="City or State">
        <ul class="suggestions">
            <li>Filter for a city</li>
            <li>or a state</li>
        </ul>
    </form>
    <script>
        const endpoint = 'https://gist.githubusercontent.com/Miserlou/c5cd8364bf9b2420bb29/raw/2bf258763cdddd704f8ffd3ea9a3e81d25e2c6f6/cities.json';
        const cities = [];

        /*
        åŒæ­¥callBack: æŠŠfunctionç•¶åƒæ•¸å‚³åˆ°å¦ä¸€å€‹functionè£¡ -> ç­‰å¾…æ™‚æ©Ÿå¾ŒåŸ·è¡Œã€‚
        ä¸åŒæ­¥callBack:æ»¿è¶³æŸä¸€æ¢ä»¶å¾ŒåŸ·è¡Œã€‚
        */

        /*é€™è£¡è§£é‡‹ç‚ºä»€éº¼json()æœƒreturnä¸€å€‹Promise
        Q:why does response.json() return a promise?
        A:Calling .json() gets you another promise for the body of the http response that is yet to be loaded;
        The header can already be processed while the body is not yet finished,the promise waits for the body data to load.  
        */

        //Promiseæ˜¯ä¸€å€‹ç”¨ä¾†è™•ç†éåŒæ­¥äº‹ä»¶çš„æ–¹æ³•ï¼Œæ˜¯å°æœªä¾†ä¸å¯é æœŸçš„äº‹ä»¶çš„ä¸€å€‹æ‰¿è«¾ã€‚
        //å‚³çµ¦then()çš„å‡½å¼æœƒåœ¨Promise resolveå¾Œè¢«ç•°æ­¥åŸ·è¡Œã€‚
        //fetch()çš„Promiseåœ¨ç™¼é€å‡ºhttp request ç­‰å¾…ï¼Œä¸”serverå›æ‡‰(æˆåŠŸ or 404æˆ–æ˜¯ä¸€äº›éŒ¯èª¤ç­‰è«‹æ±‚å¤±æ•—)ä¹‹å¾Œï¼Œpromiseçš„ç‹€æ…‹éƒ½æœƒæ˜¯resolved(åªæœ‰é‡åˆ° "ç¶²è·¯éŒ¯èª¤" æ‰å‘ˆç¾rejected)ã€‚
        //fetch()ã€then()æœƒå›å‚³Promiseç‰©ä»¶
        let promise = fetch(endpoint); //Window.fetch(endpoint)

        console.log(promise); //{<pending>} "pending" undefined

        promise.then((response) => { //onFulfilled æ–¹æ³•ä¾†å®šç¾©ä½œæ¥­æˆåŠŸæ™‚çš„è™•ç†æ–¹å¼(ä¸åŒæ­¥ã€å¾®ä»»å‹™)ã€‚

                console.log(promise); //{<resolved>} "resolved" Response

                //console.log(typeof(fetch(endpoint)));//object
                //console.log(response); //é€™æ˜¯ä¸€å€‹responseç‰©ä»¶ï¼Œè€Œæˆ‘å€‘è¦çš„è³‡æºéƒ½å­˜åœ¨response.bodyè£¡ï¼Œæ˜¯ä¸€å€‹ReadableStreamç‰©ä»¶(ç„¡æ³•ç›´æ¥è®€å–è³‡æ–™å…§å®¹)ã€‚
                //console.log(response.bodyUsed); //false
                //console.log(response.json()); //Body.json()(response method)ï¼Œä½¿ç”¨jsonä¾†è®€å–ReadableStreamç‰©ä»¶;è¿”å›ä¸€å€‹promise;resolved value:Array(1000)ã€‚
                //body(ReadableStream)åªèƒ½è¢«è®€å–ä¸€æ¬¡ï¼ŒbodyUsedçš„å€¼æœƒè¢«ä¿®æ”¹æˆtrueï¼Œä¹‹å¾Œä¸èƒ½å†è®€å–äº†ã€‚
                //console.log(response.bodyUsed); //true; console.log(response.json())è®€éä¸€æ¬¡äº†ã€‚            

                if (response.ok) { //ç”¨response.ok(property)ä¾†åˆ¤æ–·fetchè«‹æ±‚æ˜¯å¦æˆåŠŸã€‚å¦‚æœokæ˜¯trueï¼Œè¡¨ç¤ºç‹€æ…‹ç¢¼åœ¨200~299ä¹‹é–“ã€‚
                    return response.json(); //returnä¸€å€‹Promiseç‰©ä»¶
                } else {
                    console.log("error"); //è«‹æ±‚å¤±æ•—æœƒå°å‡ºé€™è¡Œã€‚
                }
            })
            .then((data) => {

                /*é€™è£¡è§£é‡‹ç‚ºä»€éº¼å¿…é ˆè¦ä½¿ç”¨å±•é–‹é‹ç®—å­å±•é–‹dataæ‰èƒ½pushé€²ç©ºé™£åˆ—è£¡ã€‚

                //console.log(data); //Array(1000)
                //cities.push(data); //[Array(1000)]æŠŠä¸€å€‹arrayç‰©ä»¶å¡é€²ç©ºé™£åˆ—è£¡ï¼Œè®Šæˆé™£åˆ—ä¸­çš„é™£åˆ—ã€‚
                //console.log(cities);
                //console.log(...data); //ç„¡åºåˆ—çš„ç‰©ä»¶å€‘;å±•é–‹é‹ç®—å­æœƒæŠŠä¸€çµ„é™£åˆ—å±•é–‹ï¼Œè®Šæˆä¸€ç­†ä¸€ç­†ç¨ç«‹çš„å€‹åˆ¥å€¼ã€‚
                
                */

                cities.push(...data); //Array(1000)//array.push()æ–°æ·»åŠ arrayçš„æœ€å¾Œçš„ä¸€ç­†è³‡æ–™;array.pop()åˆªé™¤arrayçš„æœ€å¾Œä¸€ç­†è³‡æ–™ã€‚


                /*é€™è£¡è§£é‡‹æ“ä½œé™£åˆ—æ™‚æœƒæœ‰çš„å°é™·é˜±
               
                let a1 = ['x', 'y'];
                let a2 = ['w', a1, 'z'];
                console.log(a2);
                (3) ["w", Array(2), "z"]
                    0: "w"
                    1: (2) ["x", "y"]
                    2: "z"
                    length: 3
                    __proto__: Array(0)

                let a1 = ['x', 'y'];
                let a2 = ['w', ...a1, 'z'];
                console.log(a2);
                (4) ["w", "x", "y", "z"]
                    0: "w"
                    1: "x"
                    2: "y"
                    3: "z"
                    length: 4
                    __proto__: Array(0)


                let family=[{"name":"Andy","age":"24","hometown":"Taiwan"}];
                console.log(family);
                   
                [{â€¦}]
                    0: age: "24"
                       hometown: "Taiwan"
                       name: "Andy"
                       __proto__: Object
                       length: 1
                    __proto__: Array(0)
                */
                console.log(promise); //{<resolved>} "resolved" Response
            });



        //ç”¨jsä¾†æ“ä½œç€è¦½å™¨æä¾›çš„DOM api
        let searchInput = document.querySelector('.search');
        //console.log(searchInput); //<input type="text" class="search" placeholder="City or State">
        //console.dir(searchInput); //input.searchç‰©ä»¶( HTMLInputElementçš„å¯¦ä¾‹)

        searchInput.addEventListener('keyup', e => { //ä½¿ç”¨è€…é‡‹æ”¾æŸä¸€å€‹æŒ‰éµæ™‚è§¸ç™¼

            //ç¬¬ä¸€æ­¥ æ‹¿é™£åˆ—è³‡æ–™å»éæ¿¾ä½¿ç”¨è€…è¼¸å…¥çš„éµç¢¼(ex.n)
            //Array.filter()-->æŠŠæŸäº›å…ƒç´ éæ¿¾æ‰ï¼Œç„¶å¾Œå‰©ä¸‹çš„å…ƒç´ çµ„æˆæ–°é™£åˆ—return
            let filterArray = cities.filter(place => { //æœ‰åºçš„ç•¶å‰è³‡æ–™å‘¼å«callBackä¸€æ¬¡ä¾†é€²è¡Œæ¢ä»¶éæ¿¾(é‹ä½œåŸç†åŒforEach)ï¼Œæ‰€ä»¥åœ¨é€™è£¡callbackè¦è¢«å‘¼å«1000æ¬¡

                //æ­£å‰‡è¡¨é”å¼-->è¨­å®šéæ¿¾è¦å‰‡-->ä½¿ç”¨è€…è¼¸å…¥çš„éµç¢¼
                let regex = new RegExp(e.target.value, 'gi'); //'g'å…¨å±€åŒ¹é… 'i'ä¸åˆ†å¤§å°å¯«
                //console.log(regex);/n/gi
                //console.dir(regex);/n/giç‰©ä»¶

                /*æ­é…RegExpçš„æ–¹æ³•
                String.match()-->ä½¿æ¯”å°è¦å‰‡ï¼Œæ‰¾å‡ºç¬¦åˆè¦å‰‡çš„å­—ä¸²ï¼Œç„¶å¾Œå›å‚³å­—ä¸²é™£åˆ—
                String.replace()-->ä½¿æ¯”å°è¦å‰‡ï¼Œç¬¦åˆè¦å‰‡çš„å­—ä¸²è¢«ç¬¬äºŒå€‹åƒæ•¸å–ä»£
                */

                //ORé‚è¼¯é‹ç®—å­-->åªè¦å…¶ä¸­ä¸€å€‹çš„æ¢ä»¶æˆç«‹(ä¾‹å¦‚åªè¦ç¬¬ä¸€å€‹æˆç«‹ï¼Œå¾Œé¢æ¢ä»¶å°±ä¸æœƒé‹ç®—äº†)ï¼Œå°±å›å‚³true
                //console.log(place.city.match(regex) || place.state.match(regex)); //["N"]-->é‚è¼¯é‹ç®—å­æœƒè½‰æ›ç‚ºtrue


                //æœ‰ä½¿ç”¨è€…è¼¸å…¥çš„éµç¢¼çš„å…§å®¹çš„å…ƒç´ ä¿ç•™ä¸‹ä¾†æ”¾é€²æ–°é™£åˆ—è£¡
                return place.city.match(regex) || place.state.match(regex); //filter()æ ¹æ“šå›å‚³å€¼æ˜¯trueé‚„æ˜¯falseæ±ºå®šä¿ç•™é‚„æ˜¯ä¸Ÿæ£„è©²å…ƒç´ (ä¿ç•™çš„å…ƒç´ æ”¾é€²æ–°é™£åˆ—è£¡)ã€‚
            })

            console.log(filterArray); //è³‡æ–™ç¯©é¸å®Œå¾Œçš„æ–°é™£åˆ—

            //ç¬¬äºŒæ­¥ å°‡éæ¿¾éçš„è³‡æ–™hightlight           
            let list = filterArray.map(place => { //è·ŸforEachå·®åˆ¥æ˜¯mapæœƒæ§‹æˆä¸€å€‹æ–°çš„é™£åˆ—
                let regex = new RegExp(e.target.value, 'gi');

                //å­—ä¸²æ¨¡æ¿èªæ³•:${}-->æŠŠè®Šæ•¸è®Šæˆå­—ä¸²:expression.toString()
                //jsé™¤äº†æ“ä½œç¯€é»ç‰©ä»¶æ”¹è®Šhtmlä¹‹å¤–ï¼Œjsæ“æ§çš„htmlå­—ä¸²ä¹Ÿæœƒè½‰è®Šæˆç¯€é»ç‰©ä»¶ã€‚
                let cityHight = place.city.replace(regex, `<span class="h1" style="background:#ffc600">${e.target.value}</span>`);
                //console.log(cityHight); //<span class="h1" style="background:#ffc600">n</span>ew York
                //console.log(typeof(cityHight)); //string
                //console.log(cityHight); //Chicago === console.log(place.city)

                let stateHight = place.state.replace(regex, `<span class="h1"style="background:#ffc600">${e.target.value}</span>`);

                return `<li><span>${cityHight},${stateHight}</span></li>` //å°‡å­—ä¸²å‚³å‡ºå»ï¼Œç„¶å¾Œmap()æœƒpushé€²æ–°é™£åˆ—è£¡å†return

            });
            console.log(list);
            let listString = list.join(''); //join(''); //join()æœƒå°‡é™£åˆ—ï¼ˆæˆ–é¡é™£åˆ—ï¼‰ä¸­æ‰€æœ‰çš„å…ƒç´ é€£æ¥ã€åˆä½µæˆä¸€å€‹å­—ä¸²:å¦‚æœåƒæ•¸æ˜¯ç©ºå­—ä¸²ï¼Œåˆä½µå¾Œï¼Œå…ƒç´ é–“ä¸æœƒæœ‰ä»»ä½•å­—å…ƒã€‚
            console.log(listString);
            //console.log(typeof(listString));//string


            let suggestions = document.querySelector('.suggestions');
            //innerHTMLæ˜¯åŒ…å«tagçš„htmlå­—ä¸²
            suggestions.innerHTML = listString; //å°‡htmlå­—ä¸²æ›´æ”¹ç¯€é»ç‰©ä»¶çš„innerHTML //innerHTMLä½¿ç”¨ä¸Šè¦å°å¿ƒXSSæ”»æ“Šã€‚
            //console.dir(suggestions);

        });
    </script>
</body>

</html>